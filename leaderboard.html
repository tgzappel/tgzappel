<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="index.html"><img src="The.png" class="nav-logo"></a>
        <div class="nav-links">
            <a href="index.html">Levels</a>
            <a href="leaderboard.html" class="active">Leaderboard</a>
        </div>
    </nav>

    <div id="container" style="max-width: 800px; margin: 40px auto; padding: 20px;">
        <h1 style="text-align:center;">Top Players</h1>
        <div class="search-box">
            <input type="text" id="pSearch" placeholder="Search player..." onkeyup="renderLevels()">
        </div>
        <div id="leaderboard-list"></div>
    </div>

    <div id="playerModal" class="modal">
        <div class="modal-content">
            <span onclick="closePlayerModal()" style="position:absolute; right:20px; top:15px; cursor:pointer; font-size:24px; color:#ccc;">&times;</span>
            <div id="player-modal-body"></div>
        </div>
    </div>

    <script src="data.js"></script>
    <script>
        function renderLevels() {
    if (!window.DATA || !window.DATA.players || !window.DATA.levels) return;
    const search = document.getElementById('pSearch').value.toLowerCase();
    
    const list = DATA.players.map(p => {
        let pts = 0;
        let validComps = 0;

        p.completions.forEach(compId => {
            // Normalize ID for matching
            const cleanId = String(compId).trim();
            const foundLevel = DATA.levels.find(lvl => String(lvl.id).trim() === cleanId);

            if (foundLevel) {
                pts += parseFloat(foundLevel.points) || 0;
                validComps++;
            }
        });

        return { name: p.name, pts: pts, count: validComps };
    })
    .filter(p => p.name.toLowerCase().includes(search))
    .sort((a, b) => b.pts - a.pts);

    document.getElementById('leaderboard-list').innerHTML = list.map((p, i) => {
        let rankDisplay = `#${i + 1}`;
        if (i === 0) rankDisplay = "ðŸ¥‡";
        if (i === 1) rankDisplay = "ðŸ¥ˆ";
        if (i === 2) rankDisplay = "ðŸ¥‰";

        return `
        <div class="level-entry" onclick="showPlayerDetails('${p.name.replace(/'/g, "\\'")}')">
            <div class="level-rank">${rankDisplay}</div>
            <div class="level-info">
                <b>${p.name}</b><br>
                <small>${p.count} completions</small>
            </div>
            <div class="level-points">${p.pts.toLocaleString()} pts</div>
        </div>`;
    }).join('');
}

function showPlayerDetails(playerName) {
    const player = DATA.players.find(p => p.name === playerName);
    if (!player) return;

    // The Fix: Ensure the modal uses the exact same cleaning logic as the points calculation
    const comps = player.completions.map(compId => {
        const cleanId = String(compId).trim();
        
        // Find the index of the level in the master list to get its rank
        const idx = DATA.levels.findIndex(l => String(l.id).trim() === cleanId);
        
        if (idx !== -1) {
            return { 
                rank: idx + 1, 
                name: DATA.levels[idx].name.trim() 
            };
        }
        return null;
    })
    .filter(x => x !== null) // Remove failed matches
    .sort((a, b) => a.rank - b.rank); // Sort by rank (#1 first)

    document.getElementById('player-modal-body').innerHTML = `
        <h2 style="margin-top:0;">${player.name}</h2>
        <p style="color:var(--text-muted); margin-bottom:15px;">Total Completions: <b>${comps.length}</b></p>
        <div style="max-height: 400px; overflow-y: auto; border-top: 1px solid #eee;">
            ${comps.map(c => `
                <div style="padding:12px 10px; border-bottom:1px solid #f9f9f9; display:flex; gap:10px;">
                    <b style="color:var(--text-muted); min-width:35px;">#${c.rank}</b>
                    <span>${c.name}</span>
                </div>`).join('')}
            ${comps.length === 0 ? '<p style="padding:20px; color:#ccc; text-align:center;">No completions found.</p>' : ''}
        </div>`;
    
    document.getElementById('playerModal').style.display = "block";
    document.body.style.overflow = "hidden";
}

function closePlayerModal() { 
    document.getElementById('playerModal').style.display="none"; 
    document.body.style.overflow="auto"; 
}
    </script>
</body>
</html>
